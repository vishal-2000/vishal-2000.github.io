{"version":3,"sources":["../../../src/redux/reducers/jobsv2.ts"],"names":["initialState","incomplete","Map","complete","jobsByRequest","jobsV2Reducer","state","action","type","cacheIsCorrupt","job","payload","set","contentDigest","jobContentDigest","result","get","Error","delete","inputPaths","requestId","jobs","Set","add"],"mappings":";;;;;AAYA,MAAMA,YAAY,GAAG,MAA8B;AACjD,SAAO;AACLC,IAAAA,UAAU,EAAE,IAAIC,GAAJ,EADP;AAELC,IAAAA,QAAQ,EAAE,IAAID,GAAJ,EAFL;AAGLE,IAAAA,aAAa,EAAE,IAAIF,GAAJ;AAHV,GAAP;AAKD,CAND;;AAQO,MAAMG,aAAa,GAAG,CAC3BC,KAAK,GAAGN,YAAY,EADO,EAE3BO,MAF2B,KASA;AAC3B,UAAQA,MAAM,CAACC,IAAf;AACE,SAAM,cAAN;AACE,aAAQD,MAAD,CAA+BE,cAA/B,GACHT,YAAY,EADT,GAEHM,KAFJ;;AAIF,SAAM,eAAN;AAAsB;AACpB,cAAM;AAAEI,UAAAA;AAAF,YAAUH,MAAM,CAACI,OAAvB;AAEAL,QAAAA,KAAK,CAACL,UAAN,CAAiBW,GAAjB,CAAqBF,GAAG,CAACG,aAAzB,EAAwC;AACtCH,UAAAA;AADsC,SAAxC;AAIA,eAAOJ,KAAP;AACD;;AAED,SAAM,YAAN;AAAmB;AACjB,cAAM;AAAEQ,UAAAA,gBAAF;AAAoBC,UAAAA;AAApB,YAA+BR,MAAM,CAACI,OAA5C;AACA,cAAM;AAAED,UAAAA;AAAF,YAAUJ,KAAK,CAACL,UAAN,CAAiBe,GAAjB,CACdF,gBADc,CAAhB;;AAIA,YAAI,CAACJ,GAAL,EAAU;AACR,gBAAM,IAAIO,KAAJ,CACH,2GADG,CAAN;AAGD;;AAEDX,QAAAA,KAAK,CAACL,UAAN,CAAiBiB,MAAjB,CAAwBR,GAAG,CAACG,aAA5B,EAZiB,CAcjB;;AACAP,QAAAA,KAAK,CAACH,QAAN,CAAeS,GAAf,CAAmBF,GAAG,CAACG,aAAvB,EAAsC;AACpCE,UAAAA,MADoC;AAEpCI,UAAAA,UAAU,EAAET,GAAG,CAACS;AAFoB,SAAtC;AAKA,eAAOb,KAAP;AACD;;AAED,SAAM,qBAAN;AAA4B;AAC1B,cAAM;AAAEO,UAAAA;AAAF,YAAoBN,MAAM,CAACI,OAAjC;AACAL,QAAAA,KAAK,CAACL,UAAN,CAAiBiB,MAAjB,CAAwBL,aAAxB;AACAP,QAAAA,KAAK,CAACH,QAAN,CAAee,MAAf,CAAsBL,aAAtB;AAEA,eAAOP,KAAP;AACD;;AAED,SAAM,oBAAN;AAA2B;AACzB,cAAM;AAAEc,UAAAA,SAAF;AAAaV,UAAAA;AAAb,YAAqBH,MAAM,CAACI,OAAlC,CADyB,CAGzB;AACA;AACA;;AACA,YAAI,CAACL,KAAK,CAACF,aAAX,EAA0B;AACxBE,UAAAA,KAAK,CAACF,aAAN,GAAsB,IAAIF,GAAJ,EAAtB;AACD;;AACD,YAAImB,IAAI,GAAGf,KAAK,CAACF,aAAN,CAAoBY,GAApB,CAAwBI,SAAxB,CAAX;;AACA,YAAI,CAACC,IAAL,EAAW;AACTA,UAAAA,IAAI,GAAG,IAAIC,GAAJ,EAAP;AACAhB,UAAAA,KAAK,CAACF,aAAN,CAAoBQ,GAApB,CAAwBQ,SAAxB,EAAmCC,IAAnC;AACD;;AACDA,QAAAA,IAAI,CAACE,GAAL,CAASb,GAAG,CAACG,aAAb;AAEA,eAAOP,KAAP;AACD;;AAED,SAAM,sBAAN;AAA6B;AAC3B,cAAM;AAAEc,UAAAA;AAAF,YAAgBb,MAAM,CAACI,OAA7B;;AACA,YAAI,CAACL,KAAK,CAACF,aAAX,EAA0B;AACxBE,UAAAA,KAAK,CAACF,aAAN,GAAsB,IAAIF,GAAJ,EAAtB;AACD;;AACDI,QAAAA,KAAK,CAACF,aAAN,CAAoBc,MAApB,CAA2BE,SAA3B;AACD;AAxEH;;AA2EA,SAAOd,KAAP;AACD,CAtFM","sourcesContent":["import {\n  ICreateJobV2Action,\n  IRemoveStaleJobV2Action,\n  IEndJobV2Action,\n  IGatsbyState,\n  IGatsbyIncompleteJobV2,\n  IGatsbyCompleteJobV2,\n  IDeleteCacheAction,\n  ISetJobV2Context,\n  IClearJobV2Context,\n} from \"../types\"\n\nconst initialState = (): IGatsbyState[\"jobsV2\"] => {\n  return {\n    incomplete: new Map(),\n    complete: new Map(),\n    jobsByRequest: new Map(),\n  }\n}\n\nexport const jobsV2Reducer = (\n  state = initialState(),\n  action:\n    | ICreateJobV2Action\n    | IRemoveStaleJobV2Action\n    | IEndJobV2Action\n    | ISetJobV2Context\n    | IClearJobV2Context\n    | IDeleteCacheAction\n): IGatsbyState[\"jobsV2\"] => {\n  switch (action.type) {\n    case `DELETE_CACHE`:\n      return (action as IDeleteCacheAction).cacheIsCorrupt\n        ? initialState()\n        : state\n\n    case `CREATE_JOB_V2`: {\n      const { job } = action.payload\n\n      state.incomplete.set(job.contentDigest, {\n        job,\n      } as IGatsbyIncompleteJobV2)\n\n      return state\n    }\n\n    case `END_JOB_V2`: {\n      const { jobContentDigest, result } = action.payload\n      const { job } = state.incomplete.get(\n        jobContentDigest\n      ) as IGatsbyIncompleteJobV2\n\n      if (!job) {\n        throw new Error(\n          `If you encounter this error, it's probably a Gatsby internal bug. Please open an issue reporting us this.`\n        )\n      }\n\n      state.incomplete.delete(job.contentDigest)\n\n      // inputPaths is used to make sure the job is not stale\n      state.complete.set(job.contentDigest, {\n        result,\n        inputPaths: job.inputPaths,\n      } as IGatsbyCompleteJobV2)\n\n      return state\n    }\n\n    case `REMOVE_STALE_JOB_V2`: {\n      const { contentDigest } = action.payload\n      state.incomplete.delete(contentDigest)\n      state.complete.delete(contentDigest)\n\n      return state\n    }\n\n    case `SET_JOB_V2_CONTEXT`: {\n      const { requestId, job } = action.payload\n\n      // A workaround for a stale cache bug:\n      // in some edge case redux cache is not cleared (even after gatsby-config and package.json changes).\n      // TODO: figure out the root cause and remove this workaround (see also CLEAR_JOB_V2_CONTEXT)\n      if (!state.jobsByRequest) {\n        state.jobsByRequest = new Map()\n      }\n      let jobs = state.jobsByRequest.get(requestId)\n      if (!jobs) {\n        jobs = new Set<string>()\n        state.jobsByRequest.set(requestId, jobs)\n      }\n      jobs.add(job.contentDigest)\n\n      return state\n    }\n\n    case `CLEAR_JOB_V2_CONTEXT`: {\n      const { requestId } = action.payload\n      if (!state.jobsByRequest) {\n        state.jobsByRequest = new Map()\n      }\n      state.jobsByRequest.delete(requestId)\n    }\n  }\n\n  return state\n}\n"],"file":"jobsv2.js"}